<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>AI Assistant â€” Mini Group</title>
  <link rel="stylesheet" href="/styles.css">
</head>
<body>
  <header class="nav"><div class="container nav-inner"><div class="logo">Mini <span class="accent">Group</span></div><nav class="nav-links"><a href="/">Home</a><a href="/demo.html">Demo</a><a href="/features.html">Features</a><a href="/pricing.html">Pricing</a><a href="/ai.html">AI</a><a href="/ai.html#ask">Ask LLM</a></nav></div></header>

  <main class="container section">
    <h1>AI Assistant</h1>
    <p class="lead">Ask the assistant to help with copy, invoices, cashflow forecasts and more. This page sends prompts to the Python AI microservice (run `uvicorn ai.app:app --port 8000` first).</p>

    <section class="card reveal" style="padding:1.25rem;">
      <label style="display:block;margin-bottom:.6rem"><strong>Prompt</strong></label>
      <textarea id="llmPrompt" rows="6" style="width:100%;padding:.6rem;border-radius:8px;border:1px solid rgba(255,255,255,0.04);background:transparent;color:inherit"></textarea>
      <div style="margin-top:.6rem;display:flex;gap:.6rem;align-items:center">
        <button id="sendPrompt" class="btn primary">Send</button>
        <button id="clearPrompt" class="btn ghost">Clear</button>
        <div id="aiStatus" style="color:var(--muted);margin-left:1rem">Idle</div>
      </div>
    </section>

    <section class="card reveal" style="margin-top:1rem;padding:1rem;">
      <h3>Response</h3>
      <pre id="llmResponse" style="white-space:pre-wrap;background:transparent;padding:.6rem;border-radius:8px;min-height:120px;color:var(--muted)"></pre>
      <div style="margin-top:.6rem;display:flex;gap:.6rem">
        <button id="copyResp" class="btn small">Copy</button>
        <button id="saveResp" class="btn small">Save</button>
      </div>
    </section>
  </main>

  <script>
    (function(){
      const send = document.getElementById('sendPrompt');
      const clear = document.getElementById('clearPrompt');
      const promptEl = document.getElementById('llmPrompt');
      const respEl = document.getElementById('llmResponse');
      const status = document.getElementById('aiStatus');
      const copyBtn = document.getElementById('copyResp');
      const saveBtn = document.getElementById('saveResp');

      function focusPrompt(){
        try{ promptEl.focus(); promptEl.scrollIntoView({behavior:'smooth', block:'center'}); }catch(e){}
      }

      // Focus if URL contains #ask or when hash changes
      if(location.hash === '#ask') focusPrompt();
      window.addEventListener('hashchange', ()=>{ if(location.hash === '#ask') focusPrompt(); });

      async function postPrompt(text){
        status.textContent = 'Sending...';
        // try same-origin first, then fallback to localhost:8000
        const endpoints = ['/llm', '/ai/llm', 'http://localhost:8000/llm'];
        let lastErr = null;
        for(const ep of endpoints){
          try{
            const res = await fetch(ep, {
              method: 'POST',
              headers: {'Content-Type':'application/json'},
              body: JSON.stringify({prompt: text, max_tokens: 400})
            });
            if(!res.ok) throw new Error('Bad response '+res.status);
            const body = await res.json();
            return body.text || body.ad || JSON.stringify(body);
          }catch(err){ lastErr = err; continue; }
        }
        throw lastErr;
      }

      send.addEventListener('click', async ()=>{
        const text = promptEl.value.trim();
        if(!text) return;
        try{
          const out = await postPrompt(text);
          respEl.textContent = out;
          status.textContent = 'OK';
        }catch(err){
          respEl.textContent = 'Error: '+err.message;
          status.textContent = 'Error';
        }
      });

      clear.addEventListener('click', ()=>{ promptEl.value=''; respEl.textContent=''; status.textContent='Idle'; });

      copyBtn.addEventListener('click', async ()=>{
        try{ await navigator.clipboard.writeText(respEl.textContent||''); copyBtn.textContent='Copied'; setTimeout(()=>copyBtn.textContent='Copy',1200);}catch(e){alert('Copy failed')}
      });

      // Save/download response as a file
      saveBtn.addEventListener('click', ()=>{
        const text = respEl.textContent || '';
        if(!text) return alert('No response to save');
        const blob = new Blob([text], {type:'text/plain;charset=utf-8'});
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        const ts = new Date().toISOString().replace(/[:.]/g,'-');
        a.href = url;
        a.download = `ai-response-${ts}.txt`;
        document.body.appendChild(a);
        a.click();
        a.remove();
        URL.revokeObjectURL(url);
      });
    })();
  </script>
</body>
</html>
